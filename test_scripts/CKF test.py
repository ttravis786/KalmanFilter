from combinatorial_kalman_filter_old_parameterisation import ckf
from clustering import preprocessor
from Seeding import linear_regression#
import pandas as pd
import time
import matplotlib.pyplot as plt
import numpy as np
import sys
#sys.setrecursionlimit(10000)

sys.path.append(r'\\wsl$\Ubuntu\home\tt1020\CombinedSim')
sys.path.append(r'\\wsl$\Ubuntu\home\tt1020\CombinedSim\DetectorSim')
sys.path.append(r'\\wsl$\Ubuntu\home\tt1020\CombinedSim\TrackSim')
import combinedsim

if False:
       # Get data
       output, detector = combinedsim.run_sim({'muon': 5}, 0.5, 0.5)
       df = output['detector']
       df.time = df.time * 1e9
       df = df.sort_values(by='time')
       df = df[df.time <= 25]

       # Process it
       preprocessor_ob = preprocessor.PreProcesser(df)
       #fig, ax = plt.subplots()
       #ax.plot(df.real_x, df.real_y, '.', label='truth data')
       preprocessed_data = preprocessor_ob.geometric_cluster(t_step=0.3, cut_off=0.7, dist=0.6, merge=True)
       #ax.plot(preprocessed_data.x, preprocessed_data.y, 'x', label='clustered data')
       #detector.plot_output_data(fig_ax=(fig, ax), df=df)
       x, y = np.array(preprocessed_data.x), np.array(preprocessed_data.y)
       points = np.array([x, y]).T

if True:
       location = r"\\wsl$\Ubuntu\home\tt1020\CPPKalmanFilter\cplusdemo\cmake-build-debug"
       filename = "threeTracks.csv"
       df = pd.read_csv(rf"{location}\{filename}")
       points = np.array([list(df.x), list(df.y)]).T
# really don't work
if False:
       points = np.array([[ 2.65442487e+01,  3.26946935e+00],
       [ 2.64988847e+01,  1.52809248e+00],
       [ 2.55012913e+01,  3.19707424e+00],
       [ 2.55918004e+01,  1.50712397e+00],
       [ 2.44797499e+01,  3.18905278e+00],
       [ 2.46285970e+01,  1.41094318e+00],
       [ 2.37500000e+01,  3.16277662e+00],
       [ 2.37500000e+01,  1.25000000e+00],
       [ 2.30245010e+01,  1.25000000e+00],
       [ 2.29455232e+01,  3.01811155e+00],
       [ 2.22500000e+01,  1.25000000e+00],
       [ 2.20211927e+01,  2.85282538e+00],
       [ 2.11674504e+01,  2.77904332e+00],
       [ 2.12233015e+01,  1.13481035e+00],
       [ 2.02500000e+01,  2.79063964e+00],
       [ 2.02500000e+01,  9.85484303e-01],
       [ 1.95123522e+01,  2.70662566e+00],
       [ 1.94472087e+01,  8.19318987e-01],
       [ 1.85947686e+01,  2.47223702e+00],
       [ 1.87500000e+01,  7.50000000e-01],
       [ 1.77878893e+01,  2.39122024e+00],
       [ 1.80264806e+01,  6.34888359e-01],
       [ 1.69861408e+01,  3.06135355e-01],
       [ 1.69414948e+01,  2.25000000e+00],
       [ 1.59708821e+01,  2.12164662e+00],
       [ 1.62500000e+01,  2.50000000e-01],
       [ 1.50739232e+01,  1.79774358e+00],
       [ 1.54839176e+01,  1.58774729e-01],
       [ 1.43371990e+01,  1.75000000e+00],
       [ 1.45729119e+01, -1.69247288e-01],
       [ 1.34924445e+01,  1.61071354e+00],
       [ 1.35030116e+01, -4.85520922e-01],
       [ 1.24670037e+01,  1.34963370e+00],
       [ 1.27500000e+01, -7.50000000e-01],
       [ 1.16031550e+01,  1.03278749e+00],
       [ 1.08774383e+01,  8.99692035e-01],
       [ 1.16164691e+01, -1.06028480e+00],
       [ 9.96741274e+00,  6.20569170e-01],
       [ 1.04967950e+01, -1.37013337e+00],
       [ 8.97300473e+00,  3.59294179e-01],
       [ 9.49625913e+00, -1.75000000e+00],
       [ 8.25000000e+00,  1.35715352e-02],
       [ 8.48493992e+00, -2.15153410e+00],
       [ 7.75000000e+00, -2.45464963e+00],
       [ 7.48758879e+00, -1.87336550e-01],
       [ 6.49249639e+00, -4.78639140e-01],
       [ 6.95799762e+00, -2.81535320e+00],
       [ 5.75000000e+00, -8.17640645e-01],
       [ 5.99285632e+00, -3.26736419e+00],
       [ 5.02112522e+00, -1.01439237e+00],
       [ 5.25000000e+00, -3.65039899e+00],
       [ 4.02007449e+00, -1.46973098e+00],
       [ 4.43346583e+00, -3.91525082e+00],
       [ 2.98824502e+00, -1.89020749e+00],
       [ 3.48532590e+00, -4.45781394e+00],
       [ 2.75000000e+00, -4.75000000e+00],
       [ 2.10264177e+00, -2.17305401e+00],
       [ 1.38198989e+00, -2.71150216e+00],
       [ 1.96359789e+00, -5.15643054e+00],
       [ 4.74332912e-01, -3.03203000e+00],
       [ 1.06492808e+00, -5.82566692e+00],
       [ 2.50000000e-01, -6.32855693e+00],
       [-2.50000000e-01, -3.62265772e+00],
       [-1.03702318e+00, -3.40344985e+00],
       [-4.72216504e-01, -6.68878867e+00],
       [-1.77362204e+00, -4.07072099e+00],
       [-1.11849094e+00, -7.25000000e+00],
       [-2.60052238e+00, -4.47309668e+00],
       [-2.54630357e+00, -5.05381835e+00],
       [-1.75000000e+00, -7.57024926e+00],
       [-2.51143300e+00, -8.15330643e+00],
       [-3.36427617e+00, -4.90039427e+00],
       [-4.11036403e+00, -5.53876306e+00],
       [-5.02280936e+00, -5.41255798e+00],
       [-3.92851691e+00, -9.09299006e+00],
       [-4.75000000e+00, -6.52130830e+00],
       [-5.54804973e+00, -6.84559598e+00],
       [-5.97826243e+00, -6.28498357e+00],
       [-4.63745027e+00, -9.82423429e+00],
       [-5.55890954e+00, -1.04812853e+01],
       [-6.35860695e+00, -7.25623764e+00],
       [-6.75000000e+00, -6.39907070e+00],
       [-7.47811770e+00, -6.95198543e+00],
       [-7.05662534e+00, -7.89550114e+00],
       [-6.25000000e+00, -1.10015125e+01],
       [-7.88727203e+00, -8.26025765e+00],
       [-8.25000000e+00, -7.46380720e+00],
       [-6.75000000e+00, -1.15358469e+01],
       [-7.49418623e+00, -1.20607430e+01],
       [-9.02728294e+00, -8.04720301e+00],
       [-8.49578127e+00, -9.01112579e+00],
       [-8.14714029e+00, -1.27500000e+01],
       [-9.25000000e+00, -9.59110707e+00],
       [-9.75000000e+00, -8.46487047e+00],
       [-9.95271062e+00, -1.01098185e+01],
       [-8.75000000e+00, -1.32500000e+01],
       [-1.05205802e+01, -8.98740554e+00],
       [-9.38783288e+00, -1.39801149e+01],
       [-1.05750703e+01, -1.07261326e+01],
       [-1.12500000e+01, -9.45853417e+00],
       [-1.10831834e+01, -1.12500000e+01],
       [-1.01462953e+01, -1.47500000e+01],
       [-1.17500000e+01, -9.93390208e+00],
       [-1.19608949e+01, -1.19038888e+01],
       [-1.25459689e+01, -1.04868661e+01],
       [-1.06485275e+01, -1.51645968e+01],
       [-1.26950556e+01, -1.26533665e+01],
       [-1.32500000e+01, -1.10358560e+01],
       [-1.10718641e+01, -1.57500000e+01],
       [-1.18592244e+01, -1.65193750e+01],
       [-1.32500000e+01, -1.31257779e+01],
       [-1.39259122e+01, -1.15440076e+01],
       [-1.39767584e+01, -1.37500000e+01],
       [-1.47500000e+01, -1.22500000e+01],
       [-1.24177474e+01, -1.72500000e+01],
       [-1.27500000e+01, -1.77500000e+01],
       [-1.52500000e+01, -1.26295603e+01],
       [-1.45369274e+01, -1.42500000e+01],
       [-1.35280719e+01, -1.85280719e+01],
       [-1.50870508e+01, -1.49571398e+01],
       [-1.59012875e+01, -1.31147727e+01],
       [-1.41404655e+01, -1.91933981e+01],
       [-1.65956378e+01, -1.38917878e+01],
       [-1.56881851e+01, -1.56182876e+01],
       [-1.72500000e+01, -1.44287210e+01],
       [-1.62500000e+01, -1.61176933e+01],
       [-1.45269064e+01, -1.99286935e+01],
       [-1.69519691e+01, -1.68585405e+01],
       [-1.51613781e+01, -2.07500000e+01],
       [-1.79644919e+01, -1.50806724e+01],
       [-1.77500000e+01, -1.76597925e+01],
       [-1.55955569e+01, -2.12500000e+01],
       [-1.85910469e+01, -1.57500000e+01],
       [-1.81153713e+01, -1.82500000e+01],
       [-1.58930220e+01, -2.17500000e+01],
       [-1.96855908e+01, -1.67881042e+01],
       [-1.85845110e+01, -1.89345840e+01]])
# four tracks
if False:
       points = np.array([[ 2.64877898e+01,  2.29324047e+00],
              [ 2.65028384e+01, -1.43097227e+00],
              [ 2.59988025e+01, -5.75000000e+00],
              [ 2.55996581e+01, -1.55538552e+00],
              [ 2.50478072e+01, -5.75000000e+00],
              [ 2.55308205e+01,  2.30752256e+00],
              [ 2.48942015e+01, -1.43234211e+00],
              [ 2.43726312e+01,  2.25000000e+00],
              [ 2.42500000e+01, -5.75000000e+00],
              [ 2.39884111e+01, -1.52908019e+00],
              [ 2.37500000e+01,  2.25000000e+00],
              [ 2.35494145e+01, -5.90158432e+00],
              [ 2.30441511e+01, -1.75375900e+00],
              [ 2.30248104e+01,  2.24074373e+00],
              [ 2.25106654e+01, -6.00231518e+00],
              [ 2.22500000e+01,  2.25000000e+00],
              [ 2.17500000e+01, -6.09160203e+00],
              [ 2.22500000e+01, -1.95915042e+00],
              [ 2.10545287e+01, -2.02937611e+00],
              [ 2.07162186e+01, -6.25000000e+00],
              [ 2.15135620e+01,  2.15066233e+00],
              [ 1.97500000e+01, -6.25000000e+00],
              [ 2.04572290e+01, -2.04277095e+00],
              [ 1.99182269e+01, -2.04254511e+00],
              [ 1.90867339e+01, -6.25000000e+00],
              [ 1.98769559e+01,  1.82157361e+00],
              [ 1.89878214e+01, -2.22118144e+00],
              [ 1.87500000e+01,  1.75000000e+00],
              [ 1.82500000e+01, -6.42336025e+00],
              [ 1.80179282e+01, -2.40121962e+00],
              [ 1.80508508e+01,  1.71762844e+00],
              [ 1.73956832e+01, -6.50951574e+00],
              [ 1.70258110e+01, -2.75000000e+00],
              [ 1.64596089e+01, -6.75000000e+00],
              [ 1.69710112e+01,  1.51958168e+00],
              [ 1.62440591e+01, -2.79859522e+00],
              [ 1.55186706e+01, -6.72734321e+00],
              [ 1.60206539e+01,  1.25000000e+00],
              [ 1.52500000e+01,  1.25000000e+00],
              [ 1.53234776e+01, -3.05646921e+00],
              [ 1.47500000e+01, -6.90032350e+00],
              [ 1.46137749e+01, -3.22055684e+00],
              [ 1.40175577e+01, -7.07308464e+00],
              [ 1.44369465e+01,  1.06674696e+00],
              [ 1.37666875e+01, -3.40278838e+00],
              [ 1.35031896e+01,  7.50000000e-01],
              [ 1.32500000e+01, -7.25000000e+00],
              [ 1.25487307e+01, -7.25000000e+00],
              [ 1.29000728e+01, -3.82523803e+00],
              [ 1.24763378e+01,  5.54159892e-01],
              [ 1.19565594e+01, -7.45894598e+00],
              [ 1.20824872e+01, -3.91217741e+00],
              [ 1.12500000e+01, -7.75000000e+00],
              [ 1.17500000e+01,  3.56887734e-01],
              [ 1.06471369e+01, -7.85286312e+00],
              [ 1.09564848e+01, -4.13273926e+00],
              [ 1.10191201e+01,  1.58747959e-01],
              [ 1.14812826e+01, -4.09739800e+00],
              [ 1.10783914e+01, -4.66708734e+00],
              [ 1.01857334e+01, -4.49431588e+00],
              [ 9.88274001e+00, -2.50000000e-01],
              [ 9.56355300e+00, -8.09650758e+00],
              [ 9.25000000e+00, -2.50000000e-01],
              [ 9.61685433e+00, -5.11685433e+00],
              [ 9.00089364e+00, -5.26878728e+00],
              [ 8.49831504e+00, -4.86217711e+00],
              [ 8.52440342e+00, -5.72380649e-01],
              [ 7.97798299e+00, -8.49955495e+00],
              [ 7.51269406e+00, -5.13463989e+00],
              [ 7.52537919e+00, -8.51325035e-01],
              [ 8.02557701e+00, -5.52557701e+00],
              [ 7.25000000e+00, -8.75000000e+00],
              [ 6.75000000e+00, -1.25000000e+00],
              [ 7.55923078e+00, -6.17040211e+00],
              [ 6.75000000e+00, -5.35488266e+00],
              [ 6.31214173e+00, -9.02117475e+00],
              [ 5.96551108e+00, -5.75000000e+00],
              [ 5.95200633e+00, -1.40086813e+00],
              [ 6.49372599e+00, -6.74916515e+00],
              [ 5.25000000e+00, -9.25000000e+00],
              [ 5.75000000e+00, -7.25000000e+00],
              [ 5.02157975e+00, -1.75000000e+00],
              [ 4.52163305e+00, -9.67344152e+00],
              [ 4.99797988e+00, -6.00184744e+00],
              [ 4.97706914e+00, -7.52293086e+00],
              [ 3.97252769e+00, -2.16382259e+00],
              [ 3.96453328e+00, -6.42530920e+00],
              [ 3.49381959e+00, -1.00061804e+01],
              [ 3.04276797e+00, -2.58811287e+00],
              [ 2.97230189e+00, -6.82522999e+00],
              [ 2.47719008e+00, -1.03427758e+01],
              [ 4.13120153e+00, -8.07734523e+00],
              [ 1.46198782e+00, -1.07650739e+01],
              [ 3.25000000e+00, -8.75000000e+00],
              [ 2.25000000e+00, -7.25000000e+00],
              [ 2.25000000e+00, -2.93742614e+00],
              [ 1.50402605e+00, -7.44977650e+00],
              [ 7.50000000e-01, -1.11360487e+01],
              [ 1.55296187e+00, -3.13824516e+00],
              [ 2.53969335e+00, -9.15071342e+00],
              [ 1.82483985e+00, -9.67317679e+00],
              [ 5.57961197e-01, -7.87611700e+00],
              [-2.79240835e-02, -1.14392084e+01],
              [ 7.50000000e-01, -3.75000000e+00],
              [-7.50000000e-01, -1.17500000e+01],
              [-2.50000000e-01, -8.25000000e+00],
              [-1.55750822e-02, -3.94258277e+00],
              [ 1.05513028e+00, -1.00920088e+01],
              [ 4.22470690e-01, -1.07500000e+01],
              [-1.50391408e+00, -1.20833930e+01],
              [-1.01970673e+00, -8.64112702e+00],
              [-1.03819167e+00, -4.45562503e+00],
              [-1.75000000e+00, -4.75000000e+00],
              [-2.48108364e+00, -1.25026642e+01],
              [-1.75000000e+00, -9.02392986e+00],
              [-2.50000000e-01, -1.10662747e+01],
              [-2.55698879e+00, -9.42513436e+00],
              [-2.49367575e+00, -5.22020545e+00],
              [-9.19005126e-01, -1.16057764e+01],
              [-3.25000000e+00, -1.30227691e+01],
              [-3.49538397e+00, -5.68186608e+00],
              [-1.55803380e+00, -1.23827819e+01],
              [-4.02308217e+00, -1.33223425e+01],
              [-3.25000000e+00, -9.75000000e+00],
              [-4.17106267e+00, -6.17156650e+00],
              [-2.25000000e+00, -1.28879494e+01],
              [-4.01278721e+00, -1.01632583e+01],
              [-4.75000000e+00, -1.36211736e+01],
              [-5.62665671e+00, -1.41266567e+01],
              [-4.99326566e+00, -6.57258892e+00],
              [-2.92897592e+00, -1.34289759e+01],
              [-4.88711360e+00, -1.08871136e+01],
              [-5.75000000e+00, -7.05749256e+00],
              [-6.45031959e+00, -1.45980746e+01],
              [-3.75000000e+00, -1.42500000e+01],
              [-6.46624983e+00, -7.53124147e+00],
              [-6.34213285e+00, -1.15515723e+01],
              [-7.17595459e+00, -1.51194936e+01],
              [-4.25000000e+00, -1.46596202e+01],
              [-4.95973345e+00, -1.53298163e+01],
              [-7.09097030e+00, -1.22149884e+01],
              [-8.00323974e+00, -1.55032397e+01],
              [-7.25000000e+00, -7.92936053e+00],
              [-7.99927826e+00, -8.48689335e+00],
              [-5.75000000e+00, -1.62500000e+01],
              [-7.93815423e+00, -1.26147173e+01],
              [-8.75000000e+00, -1.59812813e+01],
              [-8.58132048e+00, -1.32500000e+01],
              [-9.37821397e+00, -1.62500000e+01],
              [-6.16808054e+00, -1.67500000e+01],
              [-8.75000000e+00, -8.96702629e+00],
              [-6.63535013e+00, -1.72500000e+01],
              [-9.43670134e+00, -9.54895618e+00],
              [-1.02500000e+01, -1.69023417e+01],
              [-9.44930266e+00, -1.35668766e+01],
              [-1.08412462e+01, -1.73412462e+01],
              [-7.17658797e+00, -1.79742759e+01],
              [-1.01973133e+01, -1.00509641e+01],
              [-9.90983915e+00, -1.42500000e+01],
              [-7.75000000e+00, -1.85615422e+01],
              [-1.07500000e+01, -1.46433698e+01],
              [-1.17500000e+01, -1.79682559e+01],
              [-1.07500000e+01, -1.04931046e+01],
              [-8.31482203e+00, -1.91814417e+01],
              [-1.14951289e+01, -1.09951289e+01],
              [-1.25525971e+01, -1.84885922e+01],
              [-1.15411899e+01, -1.52515122e+01],
              [-8.77500919e+00, -2.00198612e+01],
              [-1.22500000e+01, -1.59368583e+01],
              [-1.22500000e+01, -1.15354475e+01],
              [-1.32500000e+01, -1.90014351e+01],
              [-1.29432801e+01, -1.20347606e+01],
              [-9.36997909e+00, -2.07500000e+01],
              [-1.39878685e+01, -1.95061343e+01],
              [-1.29784451e+01, -1.63757712e+01],
              [-9.86341287e+00, -2.14594688e+01],
              [-1.47500000e+01, -2.02500000e+01],
              [-1.36351433e+01, -1.26840398e+01],
              [-1.37500000e+01, -1.70317408e+01],
              [-1.42500000e+01, -1.32500000e+01],
              [-1.52500000e+01, -2.05107158e+01],
              [-1.42500000e+01, -1.74985736e+01],
              [-1.09372671e+01, -2.30156580e+01],
              [-1.47713378e+01, -1.38017826e+01],
              [-1.59449930e+01, -2.10238847e+01],
              [-1.50242710e+01, -1.80894895e+01],
              [-1.12500000e+01, -2.37500000e+01],
              [-1.57500000e+01, -1.47500000e+01],
              [-1.55543849e+01, -1.87086472e+01],
              [-1.62500000e+01, -1.50414793e+01],
              [-1.16568408e+01, -2.45092706e+01],
              [-1.60544886e+01, -1.92500000e+01],
              [-1.70017668e+01, -2.00017668e+01],
              [-1.69482915e+01, -1.56403946e+01],
              [-1.76084361e+01, -1.64275480e+01],
              [-1.77500000e+01, -2.05878024e+01],
              [-1.82500000e+01, -1.70027659e+01],
              [-1.89305064e+01, -1.76607989e+01],
              [-1.94839755e+01, -1.82500000e+01]])

## two tracks
if False:
       points = np.array([[ 26.25      ,   4.75      ],
              [ 26.25      ,  -1.09013338],
              [ 25.50467684,   4.75      ],
              [ 25.42262506,  -1.0031579 ],
              [ 24.5551073 ,  -1.18739057],
              [ 23.49070789,  -1.25      ],
              [ 23.7992341 ,   4.5721178 ],
              [ 22.52787988,  -1.25      ],
              [ 22.75      ,   4.51928775],
              [ 21.75      ,  -1.25      ],
              [ 22.03127773,   4.32391849],
              [ 20.94813796,   4.28613121],
              [ 21.0014304 ,  -1.31542764],
              [ 20.25      ,  -1.46023675],
              [ 20.25      ,   4.25      ],
              [ 19.4714073 ,   4.2031184 ],
              [ 19.54609065,  -1.65649151],
              [ 18.48508348,  -1.78393135],
              [ 18.49861761,   4.01740398],
              [ 17.54929396,   3.88394388],
              [ 17.75      ,  -1.75      ],
              [ 16.75      ,   3.75      ],
              [ 16.88504664,  -1.99370262],
              [ 15.96861288,  -2.21117141],
              [ 15.93440888,   3.61158169],
              [ 14.95426821,   3.25      ],
              [ 14.98599686,  -2.32059306],
              [ 14.25      ,   3.25      ],
              [ 14.25      ,  -2.52393335],
              [ 13.59517546,  -2.6846626 ],
              [ 13.46190416,   3.05908877],
              [ 12.49603255,   2.75      ],
              [ 12.51377434,  -2.89340731],
              [ 11.49655631,  -3.25      ],
              [ 11.47854262,   2.52729603],
              [ 10.75      ,   2.31765653],
              [ 10.75      ,  -3.46150725],
              [  9.97177375,  -3.67350402],
              [  9.96604621,   2.05801462],
              [  9.0071458 ,   1.75      ],
              [  9.03494522,  -4.0461198 ],
              [  8.25      ,  -4.25      ],
              [  8.25      ,   1.56347597],
              [  7.54607991,   1.22626687],
              [  7.53442789,  -4.54910781],
              [  6.47788221,   0.7840966 ],
              [  6.45526161,  -4.90327519],
              [  5.75      ,  -5.25      ],
              [  5.75      ,   0.59084962],
              [  4.93706545,  -5.56293455],
              [  3.95688223,  -5.9616026 ],
              [  4.02810619,  -0.08273758],
              [  4.46540341,   0.13656937],
              [  3.02178798,  -6.41053937],
              [  3.01371482,  -0.59106257],
              [  2.25      ,  -6.75      ],
              [  2.30706817,  -1.03235465],
              [  1.64768082,  -1.35231918],
              [  1.52787752,  -7.05825848],
              [  0.4399908 ,  -1.94527221],
              [  0.75      ,  -7.5655842 ],
              [ -0.0550038 ,  -7.89764846],
              [ -0.25      ,  -2.32935786],
              [ -0.90468641,  -8.40468641],
              [ -0.97013355,  -2.664588  ],
              [ -1.75      ,  -3.13275679],
              [ -2.62760093,  -3.62760093],
              [ -2.4931148 ,  -9.25434204],
              [ -3.25      ,  -9.75      ],
              [ -3.25      ,  -4.04632457],
              [ -3.972045  , -10.1162379 ],
              [ -3.97500731,  -4.49064381],
              [ -4.66735657, -10.6734789 ],
              [ -4.75      ,  -5.10835103],
              [ -5.4215555 ,  -5.54797611],
              [ -5.45946572, -11.07812469],
              [ -6.25      ,  -6.1651862 ],
              [ -6.25      , -11.64421117],
              [ -6.96764737,  -6.59543984],
              [ -6.87693996, -12.07360804],
              [ -7.67095909,  -7.17417771],
              [ -7.50875345, -12.75      ],
              [ -8.42014247, -13.2741021 ],
              [ -8.25      ,  -7.62133026],
              [ -8.96271419,  -8.10451221],
              [ -9.25      , -14.01894021],
              [ -9.54769231,  -8.75      ],
              [ -9.75      , -14.37547981],
              [-10.3804845 ,  -9.44260154],
              [-10.52880863, -15.01187014],
              [-11.25      , -10.12416435],
              [-11.25      , -15.75      ],
              [-11.75      , -16.25      ],
              [-11.75      , -10.5906645 ],
              [-12.3690144 , -11.13863243],
              [-12.43005975, -16.58513909],
              [-13.10117988, -17.42963369],
              [-12.75      , -11.75      ],
              [-13.75      , -17.97886225],
              [-13.62637125, -12.43763892],
              [-14.42361402, -18.56856813],
              [-14.25      , -13.07692237],
              [-14.75      , -13.56602636],
              [-15.07171197, -19.21154279],
              [-15.60336156, -19.94467992],
              [-15.44545191, -14.32466618],
              [-16.1425303 , -15.25      ],
              [-16.25      , -20.5223263 ],
              [-16.62661427, -15.75      ],
              [-16.82796705, -21.08693807],
              [-17.09095588, -16.42771754],
              [-17.75      , -17.13437689],
              [-18.25      , -17.64122607],
              [-18.52580675, -18.25      ]])
#
# if True:
#        points = np.array([[2.64967513e+01, 7.50000000e-01],
#               [2.65315217e+01, -1.44816179e+00],
#               [2.59389445e+01, -4.63257183e+00],
#               [2.54989597e+01, 7.50000000e-01],
#               [2.49993650e+01, -4.75000000e+00],
#               [2.55567773e+01, -1.49860394e+00],
#               [2.42500000e+01, -4.75000000e+00],
#               [2.47500000e+01, 8.04919158e-01],
#               [2.39727739e+01, -1.71228980e+00],
#               [2.40897849e+01, 7.50000000e-01],
#               [2.34718079e+01, -4.69967622e+00],
#               [2.30348853e+01, 7.50000000e-01],
#               [2.29726926e+01, -1.75000000e+00],
#               [2.24868989e+01, -4.75000000e+00],
#               [2.22500000e+01, 7.50000000e-01],
#               [2.17500000e+01, -4.75000000e+00],
#               [2.22500000e+01, -1.87387898e+00],
#               [2.06226059e+01, -4.78122521e+00],
#               [2.11171032e+01, 5.21075516e-01],
#               [2.15076945e+01, -2.01493936e+00],
#               [2.04850333e+01, -2.25000000e+00],
#               [2.02500000e+01, 2.41085275e-01],
#               [1.97500000e+01, -4.75000000e+00],
#               [1.97500000e+01, -2.25000000e+00],
#               [1.97500000e+01, 2.50000000e-01],
#               [1.92500000e+01, -4.98085009e+00],
#               [1.91317273e+01, -2.25000000e+00],
#               [1.90008143e+01, 2.50000000e-01],
#               [1.85278721e+01, -5.16864870e+00],
#               [1.80153930e+01, -2.75000000e+00],
#               [1.74862259e+01, -5.25000000e+00],
#               [1.64552172e+01, -5.30486717e+00],
#               [1.72500000e+01, -2.75000000e+00],
#               [1.70583174e+01, -1.05994491e-01],
#               [1.62500000e+01, -2.50000000e-01],
#               [1.65208020e+01, -3.04091304e+00],
#               [1.54727149e+01, -5.47841252e+00],
#               [1.54605609e+01, -3.00838013e-01],
#               [1.55116701e+01, -3.25000000e+00],
#               [1.47500000e+01, -5.75000000e+00],
#               [1.45179477e+01, -3.56786103e+00],
#               [1.40723335e+01, -5.75000000e+00],
#               [1.44868363e+01, -5.87793105e-01],
#               [1.37500000e+01, -3.75000000e+00],
#               [1.30486492e+01, -5.84621265e+00],
#               [1.34391254e+01, -8.00073529e-01],
#               [1.27500000e+01, -7.50000000e-01],
#               [1.20129558e+01, -6.19624256e+00],
#               [1.30605442e+01, -4.08925442e+00],
#               [1.20392635e+01, -1.18328040e+00],
#               [1.19531174e+01, -4.39744151e+00],
#               [1.12500000e+01, -6.25000000e+00],
#               [1.09833930e+01, -1.36559318e+00],
#               [1.12500000e+01, -4.75000000e+00],
#               [1.04153663e+01, -6.69016656e+00],
#               [9.94134633e+00, -1.75000000e+00],
#               [9.49512043e+00, -6.76872536e+00],
#               [1.07500000e+01, -4.75000000e+00],
#               [9.25000000e+00, -1.83629241e+00],
#               [9.66264922e+00, -5.31241102e+00],
#               [8.75000000e+00, -7.01262862e+00],
#               [8.02522251e+00, -7.25000000e+00],
#               [8.75000000e+00, -5.65655526e+00],
#               [8.51770133e+00, -2.08900256e+00],
#               [8.01930801e+00, -5.98292911e+00],
#               [7.52388874e+00, -2.36112666e+00],
#               [7.02091206e+00, -7.56670273e+00],
#               [6.75000000e+00, -2.75000000e+00],
#               [7.25000000e+00, -6.25000000e+00],
#               [6.05617737e+00, -7.75000000e+00],
#               [6.01260764e+00, -2.90668995e+00],
#               [6.38872120e+00, -6.75000000e+00],
#               [5.25000000e+00, -8.12858873e+00],
#               [5.62260709e+00, -7.19119915e+00],
#               [5.02887894e+00, -3.25000000e+00],
#               [4.44842146e+00, -8.38558500e+00],
#               [3.98771885e+00, -3.75000000e+00],
#               [3.52106710e+00, -8.68978230e+00],
#               [4.33549479e+00, -7.92582854e+00],
#               [2.49237498e+00, -9.16725824e+00],
#               [3.06389559e+00, -4.11207363e+00],
#               [3.75000000e+00, -8.15329518e+00],
#               [2.98371033e+00, -8.62874304e+00],
#               [1.75000000e+00, -9.38190412e+00],
#               [2.25000000e+00, -4.39315258e+00],
#               [9.82076649e-01, -9.75000000e+00],
#               [1.55463493e+00, -4.74312330e+00],
#               [2.30148955e+00, -9.06606873e+00],
#               [1.52963509e+00, -9.53461267e+00],
#               [5.58577030e-01, -5.12757813e+00],
#               [4.56519812e-02, -1.01219351e+01],
#               [-2.50000000e-01, -5.62184403e+00],
#               [-7.50000000e-01, -1.04165700e+01],
#               [7.50000000e-01, -1.00213785e+01],
#               [1.19929011e-02, -1.05674424e+01],
#               [-9.66878803e-01, -5.85759621e+00],
#               [-1.46385978e+00, -1.08449134e+01],
#               [-2.49675440e+00, -1.13264255e+01],
#               [-7.50000000e-01, -1.10959239e+01],
#               [-2.47499566e+00, -6.63072250e+00],
#               [-3.25000000e+00, -1.17500000e+01],
#               [-2.05583066e+00, -6.42318287e+00],
#               [-1.25000000e+00, -1.17500000e+01],
#               [-2.06423554e+00, -1.20669886e+01],
#               [-3.75000000e+00, -1.19509062e+01],
#               [-4.02797837e+00, -7.52382640e+00],
#               [-2.75000000e+00, -1.26149380e+01],
#               [-4.59616136e+00, -1.24660548e+01],
#               [-5.48258483e+00, -1.28623418e+01],
#               [-4.97482549e+00, -8.09317026e+00],
#               [-3.25000000e+00, -1.30386312e+01],
#               [-6.25000000e+00, -1.33190749e+01],
#               [-5.75000000e+00, -8.54495684e+00],
#               [-3.92018875e+00, -1.35572792e+01],
#               [-4.94656582e+00, -1.45005851e+01],
#               [-7.00044888e+00, -1.37575871e+01],
#               [-6.52743150e+00, -8.95774833e+00],
#               [-8.00499136e+00, -1.43444868e+01],
#               [-5.75000000e+00, -1.51281227e+01],
#               [-7.25000000e+00, -9.44781124e+00],
#               [-8.75000000e+00, -1.47500000e+01],
#               [-8.06746706e+00, -9.96597740e+00],
#               [-6.25000000e+00, -1.57500000e+01],
#               [-6.75000000e+00, -1.61255766e+01],
#               [-9.54657626e+00, -1.53673896e+01],
#               [-8.75000000e+00, -1.04054831e+01],
#               [-7.40122715e+00, -1.66847318e+01],
#               [-9.55446233e+00, -1.09916221e+01],
#               [-1.02500000e+01, -1.56695880e+01],
#               [-1.08475690e+01, -1.61935558e+01],
#               [-8.03730273e+00, -1.74214717e+01],
#               [-1.02078150e+01, -1.15227569e+01],
#               [-1.09257817e+01, -1.20319334e+01],
#               [-8.69776131e+00, -1.81348662e+01],
#               [-1.14917344e+01, -1.67500000e+01],
#               [-9.17241511e+00, -1.86573547e+01],
#               [-1.16875603e+01, -1.25772758e+01],
#               [-1.22500000e+01, -1.71228378e+01],
#               [-1.22500000e+01, -1.30992596e+01],
#               [-9.94685071e+00, -1.96052594e+01],
#               [-1.29929294e+01, -1.77690385e+01],
#               [-1.30031556e+01, -1.36414469e+01],
#               [-1.04778003e+01, -2.02500000e+01],
#               [-1.37500000e+01, -1.84098968e+01],
#               [-1.45279402e+01, -1.89543081e+01],
#               [-1.37500000e+01, -1.42500000e+01],
#               [-1.10027111e+01, -2.07500000e+01],
#               [-1.15164158e+01, -2.14555723e+01],
#               [-1.44295943e+01, -1.46662849e+01],
#               [-1.52500000e+01, -1.95258291e+01],
#               [-1.50396936e+01, -1.53978687e+01],
#               [-1.57500000e+01, -2.00216453e+01],
#               [-1.21220090e+01, -2.21826598e+01],
#               [-1.25966410e+01, -2.29714346e+01],
#               [-1.64440170e+01, -2.05751458e+01],
#               [-1.57500000e+01, -1.59827380e+01],
#               [-1.71601471e+01, -2.12500000e+01],
#               [-1.31732555e+01, -2.36718984e+01],
#               [-1.64765986e+01, -1.66118554e+01],
#               [-1.67500000e+01, -1.72500000e+01],
#               [-1.75491876e+01, -1.76312628e+01],
#               [-1.82500000e+01, -1.82500000e+01]])

# initialise CKF

def strip_creator(radius=27, n_of_points=4, width=3, late_start=6):
       bins = np.linspace(-radius + late_start + late_start, radius-width, n_of_points)
       strips = []
       for b in bins:
              strips.append(((b, b+width),(-radius,radius)))
       return strips


fig, ax = plt.subplots()
plt.plot(points[:, 0], points[:, 1], 'x', label='all points')
#strips = strip_creator()
strips = [[(25,28), (-7,7)]]
B_n_arr = []
for max_it in [1000]:
       a = time.time()
       fig, ax = plt.subplots()
       for strip in strips:
              kalman_filter = ckf.CKF(max_range=5, start_range=strip, max_res=0.25, fit_order=2, max_iteration=max_it)
              kalman_filter.add_event(points)
              ps = kalman_filter.find_tracks()
              i = 0
              for s in ps:
                  for best_child, master in s:
                     i += 1
                     points_n = np.array(best_child.full_points())
                     plt.plot(points_n[:,0], points_n[:,1], 'x', label=f'track: {i}, strip {strip}')
                     B_n = best_child.X
                     B_n_arr.append(B_n)
              # x_fit = np.linspace(-27, 27, 1000)
              # plt.xlabel('x')
              # plt.ylabel('y')
              # plt.legend()
              # y_fit_n = linear_regression.linear_func(x_fit, B_n)
              # plt.plot(x_fit, y_fit_n, label=f'Kalman Fit')
              #plt.savefig(f'track: {i}, strip {strip}.png')
       print(time.time() - a)
def grouper(B_n_arr, threshold = 0.1):
       i = 0
       import copy
       similar_groups = []
       B_n_arr_copy = copy.deepcopy(B_n_arr)
       while True:
              current_item = B_n_arr_copy[i]
              for el in B_n_arr_copy:
                     pass

#plt.plot([5,8,12,15,20], [0.28990745544433594, 0.6348607540130615, 2.512479305267334, 8.118865728378296, 54.48043704032898])

# i=0
# for s in ps:
#        for best_child, master in s:
#               for c in master.get_suitable_children():
#                      i += 1
#                      fig, ax = plt.subplots()
#                      plt.plot(points[:, 0], points[:, 1], 'x', label='all points')
#                      points_n = np.array(c.full_points())
#                      plt.plot(points_n[:,0], points_n[:,1], 'x', label=f'track points: {i}')
#                      x_fit = np.linspace(-27, 27, 1000)
#                      plt.xlabel('x')
#                      plt.ylabel('y')
#                      plt.legend()
#                      #break




